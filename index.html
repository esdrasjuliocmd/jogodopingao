<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Casa de Jogos do Ping√£o üé™</title>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <style>
    :root{
      --bg1:#1b1bff; --bg2:#00d4ff; --bg3:#00ff9a; --bg4:#ffe600;
      --ink:#0a0a18;
      --card:#ffffff;
      --card2:#f7f8ff;
      --shadow: 0 14px 40px rgba(0,0,0,.18);
      --shadow2: 0 8px 22px rgba(0,0,0,.12);
      --radius: 18px;
      --radius2: 14px;
      --accent:#ff2bd6;
      --accent2:#6a5cff;
      --good:#16c172;
      --bad:#ff3b3b;
      --warn:#ffb300;
      --whatsapp:#25D366;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background: var(--ink);
      display:flex; flex-direction:column;
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      line-height:1.4;
    }
    .bg-grad{
      position:fixed; top:0; left:0; right:0; bottom:0; z-index:0;
      background: 
        radial-gradient(circle at 0% 0%, var(--bg1) 0%, transparent 50%),
        radial-gradient(circle at 100% 0%, var(--bg2) 0%, transparent 50%),
        radial-gradient(circle at 100% 100%, var(--bg3) 0%, transparent 50%),
        radial-gradient(circle at 0% 100%, var(--bg4) 0%, transparent 50%);
      background-color: var(--ink);
    }
    .main{ position:relative; z-index:1; flex:1; display:flex; flex-direction:column; height:100%; }

    /* ESTILO DO BOT√ÉO WHATSAPP (MUDAN√áA CIR√öRGICA) */
    .btn-whatsapp-copy {
      background: var(--card);
      border: 3px solid var(--whatsapp);
      border-radius: var(--radius);
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      cursor: pointer;
      margin-bottom: 20px;
      transition: transform 0.2s;
    }
    .btn-whatsapp-copy:active { transform: scale(0.96); }
    .btn-whatsapp-copy i { font-size: 50px; color: var(--whatsapp); }
    .btn-whatsapp-copy .txt-box { text-align: left; }
    .btn-whatsapp-copy b { display: block; font-size: 18px; color: var(--whatsapp); line-height: 1.1; }
    .btn-whatsapp-copy small { font-size: 11px; color: #666; display: block; margin-top: 4px; }

    .view{ display:none; flex:1; flex-direction:column; overflow-y:auto; padding:20px; animation: fadeIn 0.3s ease; }
    .view.active{ display:flex; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }
    
    .panel{ background:var(--card); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow); margin-bottom:20px; }
    .title-row{ display:flex; align-items:center; justify-content:space-between; margin-bottom:15px; }
    h1,h2,h3{ margin:0; font-weight:800; letter-spacing:-0.02em; }
    
    .input-group{ margin-bottom:15px; }
    .input-group label{ display:block; font-size:12px; font-weight:700; text-transform:uppercase; opacity:0.6; margin-bottom:6px; }
    input[type=text]{
      width:100%; background:var(--card2); border:2px solid transparent; border-radius:var(--radius2);
      padding:14px 16px; font-size:16px; font-weight:600; outline:none; transition:0.2s;
    }
    input[type=text]:focus{ border-color:var(--accent2); background:var(--card); }

    .btn{
      background:var(--accent2); color:#fff; border:none; border-radius:var(--radius2);
      padding:16px; font-size:16px; font-weight:700; cursor:pointer; transition:0.2s;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .btn:active{ transform:scale(0.96); opacity:0.9; }
    .btn-primary{ background: linear-gradient(135deg, var(--accent2), var(--accent)); box-shadow: 0 8px 20px rgba(106,92,255,0.3); }

    .ranking-mini{ display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; margin-bottom:15px; scrollbar-width:none; }
    .ranking-mini::-webkit-scrollbar{ display:none; }
    .rank-bubble{ background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); padding:8px 14px; border-radius:30px; border:1px solid rgba(255,255,255,0.2); white-space:nowrap; font-size:12px; font-weight:700; color:#fff; display:flex; align-items:center; gap:6px; }
    .rank-bubble.me{ background:var(--accent); border-color:transparent; }

    /* LAYOUT DE JOGO COMPACTO (MUDAN√áA CIR√öRGICA) */
    .game-layout{ flex:1; display:flex; flex-direction:column; gap:10px; }
    .target-box{ background:var(--bg4); border-radius:var(--radius); padding:15px; text-align:center; box-shadow:var(--shadow2); }
    .target-val{ font-size:42px; font-weight:900; color:var(--ink); line-height: 1; }
    
    .formula-visor{ background:var(--card); border-radius:var(--radius); padding:12px; min-height:50px; display:flex; align-items:center; justify-content:center; font-size:26px; font-weight:800; box-shadow:var(--shadow2); border:3px solid #eee; }
    
    /* CARTAS EM LINHA √öNICA */
    .cards-row{ display:flex; justify-content:center; gap:6px; flex-wrap:nowrap; width: 100%; margin: 5px 0; }
    .c-card{ width:18%; max-width:65px; aspect-ratio:2.5/3.5; background:var(--card); border-radius:8px; box-shadow:var(--shadow2); cursor:pointer; transition:0.2s; border:2px solid transparent; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:900; }
    .c-card:active{ transform:translateY(-5px); }
    .c-card.sel{ border-color:var(--accent); background:var(--card2); }

    .controls-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; }
    .btn-op{ background:var(--card2); color:var(--ink); border-radius:12px; padding:12px; font-size:18px; font-weight:800; border:none; cursor:pointer; }
    .btn-op:active{ background:var(--accent2); color:#fff; }
    .btn-confirm{ grid-column: span 2; background:var(--good); color:#fff; font-size:14px; text-transform:uppercase; letter-spacing:1px; }

    .player-tags{ display:flex; flex-wrap:wrap; gap:4px; justify-content:center; margin-bottom:10px; }
    .p-tag{ font-size:10px; font-weight:700; padding:3px 8px; border-radius:20px; background:rgba(0,0,0,0.1); }
    .p-tag.ready{ background:var(--good); color:#fff; }

    .timer-wrap{ height:4px; background:rgba(0,0,0,0.1); border-radius:2px; overflow:hidden; margin-top:8px; }
    .timer-bar{ height:100%; width:100%; background:var(--good); transition:width 1s linear; }

    #confetti{ position:fixed; top:0; left:0; pointer-events:none; width:100%; height:100%; z-index:9999; }
    #confetti i{ position:absolute; display:block; border-radius:2px; animation: fall linear forwards; }
    @keyframes fall{ to{ transform: translateY(100vh) rotate(360deg); } }
  </style>
</head>
<body>
  <div class="bg-grad"></div>
  <div id="confetti"></div>

  <div class="main">
    <div id="view-login" class="view active">
      <div style="text-align:center; margin-top:30px; margin-bottom:30px;">
        <h1 style="color:#fff; font-size:36px;">üé™ PING√ÉO</h1>
        <p style="color:rgba(255,255,255,0.8); font-weight:700; text-transform:uppercase; letter-spacing:2px; font-size: 12px;">Casa de Jogos</p>
      </div>
      <div class="panel">
        <div class="input-group">
          <label>Seu Apelido</label>
          <input type="text" id="in-nick" placeholder="Como te chamam?">
        </div>
        <div class="input-group" id="group-sala">
          <label>Nome da Sala</label>
          <input type="text" id="in-sala" placeholder="Nome da sala">
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="join()">SENTAR NA MESA</button>
      </div>
    </div>

    <div id="view-lobby" class="view">
      <div class="title-row">
        <h2 style="color:#fff">Mesa de Jogo</h2>
        <span class="rank-bubble" id="txt-sala-id">---</span>
      </div>

      <div class="btn-whatsapp-copy" onclick="copyLink()">
        <i class='bx bxl-whatsapp'></i>
        <div class="txt-box">
          <b>Convidar p/ WhatsApp</b>
          <small id="txt-link">Toque para copiar o link da sala</small>
        </div>
      </div>

      <div class="panel">
        <h3 style="margin-bottom:12px; font-size:12px; text-transform:uppercase; opacity:0.6;">Jogadores:</h3>
        <div id="list-lobby" style="display:flex; flex-direction:column; gap:8px;"></div>
        <button id="btn-start" class="btn btn-primary" style="width:100%; margin-top:20px; display:none" onclick="start()">DAR AS CARTAS</button>
      </div>
    </div>

    <div id="view-game" class="view">
      <div id="top-rank" class="ranking-mini"></div>
      
      <div class="game-layout">
        <div class="player-tags" id="game-players"></div>
        
        <div class="target-box">
          <div style="font-size:10px; font-weight:800; text-transform:uppercase; opacity:0.5;">Alvo da Rodada</div>
          <div class="target-val" id="target-val">?</div>
          <div class="timer-wrap"><div id="timer-bar" class="timer-bar"></div></div>
        </div>

        <div class="formula-visor" id="visor">_</div>
        <div class="cards-row" id="game-cards"></div>

        <div class="controls-grid">
          <button class="btn-op" onclick="add('+')">+</button>
          <button class="btn-op" onclick="add('-')">-</button>
          <button class="btn-op" onclick="add('*')">√ó</button>
          <button class="btn-op" onclick="add('/')">√∑</button>
          <button class="btn-op" onclick="add('(')">(</button>
          <button class="btn-op" onclick="add(')')">)</button>
          <button class="btn-op" style="background:var(--bad); color:#fff" onclick="limpar()">C</button>
          <button class="btn-confirm btn" id="btn-confirm" onclick="enviar()">CONFIRMAR</button>
        </div>
        <button class="btn" style="background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.3); font-size:11px; padding:8px;" onclick="desistir()">üè≥Ô∏è DESISTIR</button>
      </div>
    </div>
  </div>

<script>
  /* L√ìGICA INTEGRAL PRESERVADA */
  let ws, state = { nick: '', sala: '', isHost: false, target: 0, formula: '', cartasUsadas: 0, timer: 60 };

  window.onload = () => {
    const p = new URLSearchParams(window.location.search);
    if(p.get('sala')){ q('#in-sala').value = p.get('sala'); q('#group-sala').style.display='none'; }
  };

  function join(){
    state.nick = q('#in-nick').value.trim();
    state.sala = q('#in-sala').value.trim();
    if(!state.nick || !state.sala) return alert("Preencha tudo!");
    q('#txt-sala-id').innerText = state.sala;
    q('#txt-link').innerText = window.location.href.split('?')[0] + "?sala=" + encodeURIComponent(state.sala);
    mudarTela('view-lobby');
    ws = new WebSocket(`wss://pingao-backend.esdrasjulio.workers.dev/?sala=${state.sala}`);
    ws.onopen = () => ws.send(JSON.stringify({type:'JOIN', nome:state.nick}));
    ws.onmessage = (e) => handleMsg(JSON.parse(e.data));
  }

  function handleMsg(d){
    if(d.type==='INFO_PLAYER') state.isHost = d.isHost;
    if(d.type==='LISTA') updateUI(d.lista);
    if(d.type==='SUA_MAO') initRound(d);
    if(d.type==='FIM_RODADA') { if(d.vencedor===state.nick) spawnConfetti(100); }
    if(d.type==='CONTAGEM') q('#btn-confirm').innerText = `PR√ìXIMA: ${d.tempo}S`;
  }

  function updateUI(lista){
    const lobby = q('#list-lobby'); lobby.innerHTML = "";
    const pj = q('#game-players'); pj.innerHTML = "";
    const rk = q('#top-rank'); rk.innerHTML = "";
    const sorted = [...lista].sort((a,b)=>b.fichas-a.fichas);
    sorted.forEach((p,i)=>{
      lobby.innerHTML += `<div class="rank-bubble" style="background:#f0f0f0; color:#333; justify-content:space-between; width:100%"><span>${p.nome}</span> <b>üí∞${p.fichas}</b></div>`;
      rk.innerHTML += `<div class="rank-bubble ${p.nome===state.nick?'me':''}">#${i+1} ${p.nome}: ${p.fichas}</div>`;
      if(!p.eliminado) pj.innerHTML += `<div class="p-tag ${p.pronto?'ready':''}">${p.nome}</div>`;
    });
    if(state.isHost) q('#btn-start').style.display='block';
  }

  function initRound(d){
    mudarTela('view-game');
    state.target = d.alvo; state.formula = ""; state.cartasUsadas = 0;
    q('#target-val').innerText = d.alvo;
    q('#visor').innerText = "_";
    q('#btn-confirm').style.display='flex';
    q('#btn-confirm').innerText = "CONFIRMAR";
    const div = q('#game-cards'); div.innerHTML = "";
    d.cartas.forEach(n => {
      let v = n===1?'A':n===10?'0':n===11?'J':n===12?'Q':n===13?'K':n;
      div.innerHTML += `<div class="c-card" onclick="usarCarta(this,'${n}')">${v}</div>`;
    });
    startTimer();
  }

  function usarCarta(el, val){
    if(el.classList.contains('sel')) return;
    el.classList.add('sel');
    state.cartasUsadas++;
    add(val);
  }

  function add(v){ state.formula += v; q('#visor').innerText = state.formula; }
  function limpar(){ 
    state.formula = ""; state.cartasUsadas = 0; q('#visor').innerText = "_"; 
    document.querySelectorAll('.c-card').forEach(c=>c.classList.remove('sel'));
  }

  function enviar(){
    if(state.cartasUsadas < 3) return alert("Use 3+ cartas!");
    try {
      const res = eval(state.formula.replace(/[^0-9\+\-\*\/\(\)\.]/g, ''));
      ws.send(JSON.stringify({ type:'JOGADA', nome:state.nick, valor:res, distancia:Math.abs(state.target-res), tempo:60-state.timer }));
      q('#btn-confirm').style.display='none';
    } catch(e){ alert("Conta inv√°lida!"); }
  }

  function startTimer(){
    state.timer = 60;
    const bar = q('#timer-bar');
    if(window.gameTimer) clearInterval(window.gameTimer);
    window.gameTimer = setInterval(()=>{
      state.timer--;
      bar.style.width = (state.timer/60*100)+'%';
      if(state.timer<=0) clearInterval(window.gameTimer);
    },1000);
  }

  function copyLink(){
    const link = q('#txt-link').innerText;
    navigator.clipboard.writeText(link);
    alert("Link Copiado!");
  }

  function spawnConfetti(n){
    const root = q('#confetti');
    for (let i=0;i<n;i++){
      const el = document.createElement("i");
      el.style.left = Math.random()*100 + "vw"; el.style.animationDuration = (0.9 + Math.random()*0.8) + "s";
      el.style.background = ["#ff2bd6","#6a5cff","#00d4ff","#ffe600"][Math.floor(Math.random()*4)];
      el.style.width = "8px"; el.style.height = "10px";
      root.appendChild(el);
      setTimeout(()=> el.remove(), 2000);
    }
  }

  function mudarTela(id){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); q('#'+id).classList.add('active'); }
  function q(s){ return document.querySelector(s); }
  function start(){ ws.send(JSON.stringify({type:'START'})); }
  function desistir(){ ws.send(JSON.stringify({type:'DESISTIR', nome:state.nick})); }
</script>
</body>
</html>
