<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ferve a Cuca: Final</title>
    <style>
        :root {
            --ouro: #FFD700;
            --ouro-dark: #FFA000;
            --vermelho: #D32F2F;
            --vermelho-dark: #B71C1C;
            --verde: #2E7D32;
            --verde-neon: #00E676;
            --bg-mesa: #0f3818;
            --preto-transparente: rgba(0, 0, 0, 0.4);
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-mesa); 
            text-align: center; 
            margin: 0; 
            padding-bottom: 50px; 
            color: #fff; 
            overflow-x: hidden; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Topo Fixo e Ranking */
        .topo-fixo { 
            position: fixed; top: 0; left: 0; width: 100%; height: 50px; 
            background: rgba(0,0,0,0.9); display: flex; align-items: center; 
            justify-content: space-between; padding: 0 10px; z-index: 1000; 
            box-shadow: 0 2px 10px #000; box-sizing: border-box; 
        }
        .topo-info { font-size: 14px; color: var(--ouro); font-weight: bold; }
        .btn-ranking { 
            background: none; border: 1px solid var(--ouro); color: var(--ouro); 
            padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; 
        }

        /* Container Principal */
        .container { 
            margin-top: 60px; padding: 10px; max-width: 500px; margin-left: auto; margin-right: auto; 
        }

        /* Telas */
        .tela { display: none; animation: fadeIn 0.3s ease; }
        .tela.ativa { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Login */
        input[type=text] { 
            padding: 10px; font-size: 18px; border-radius: 5px; border: none; width: 80%; margin: 10px 0; 
        }
        button.btn-grande { 
            padding: 12px 25px; font-size: 18px; background: var(--ouro); color: #000; 
            border: none; border-radius: 5px; font-weight: bold; cursor: pointer; width: 80%; 
            box-shadow: 0 4px 0 var(--ouro-dark); transition: transform 0.1s; 
        }
        button.btn-grande:active { transform: translateY(4px); box-shadow: none; }

        /* √Årea de Jogo */
        .alvo-box { 
            font-size: 40px; font-weight: 900; color: var(--verde-neon); 
            text-shadow: 0 0 10px var(--verde-neon); margin: 10px 0; 
        }
        .visor-conta { 
            font-size: 24px; min-height: 40px; background: rgba(0,0,0,0.3); 
            margin: 10px; padding: 10px; border-radius: 10px; border: 1px solid #444; 
        }
        
        /* Cartas */
        .area-cartas { 
            display: flex; justify-content: center; gap: 10px; margin: 15px 0; flex-wrap: wrap; 
        }
        .carta { 
            width: 60px; height: 85px; background: #fff; color: #000; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; font-size: 24px; 
            font-weight: bold; cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); 
            position: relative; transition: transform 0.2s; 
        }
        .carta.usada { opacity: 0.4; transform: scale(0.9); pointer-events: none; background: #ddd; }
        .carta.selecionada { border: 3px solid var(--verde-neon); transform: translateY(-5px); }
        .naipe { font-size: 12px; position: absolute; top: 2px; right: 4px; }
        .carta-red { color: var(--vermelho); }

        /* Controles Matem√°ticos */
        .controles { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 10px 0; 
        }
        .btn-op { 
            padding: 15px; font-size: 20px; background: #333; color: #fff; border: none; 
            border-radius: 5px; cursor: pointer; box-shadow: 0 3px 0 #111; 
        }
        .btn-op:active { transform: translateY(3px); box-shadow: none; }
        
        .acoes-jogo { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .btn-limpar { background: var(--vermelho); color: white; flex: 1; }
        .btn-enviar { background: var(--verde); color: white; flex: 1; }
        
        /* Bot√£o Desistir - AGORA VIS√çVEL */
        .btn-desistir { 
            background: #555; color: #ccc; margin-top: 15px; width: 100%; padding: 10px; 
            border: 1px dashed #777; font-size: 14px; cursor: pointer; 
        }
        .btn-desistir:hover { background: #444; color: #fff; border-color: #fff; }

        /* Lista de Jogadores (Ranking) */
        #lista-ranking { 
            list-style: none; padding: 0; margin: 0; text-align: left; max-height: 300px; overflow-y: auto; 
        }
        .item-ranking { 
            padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; 
            align-items: center; background: rgba(0,0,0,0.5); 
        }
        .item-ranking.eliminado { color: #555; text-decoration: line-through; }
        .item-ranking.lider { border-left: 4px solid var(--ouro); }
        
        /* Modal */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 2000; display: none; 
            align-items: center; justify-content: center; flex-direction: column; 
        }
        .modal-content { 
            background: #222; padding: 20px; border-radius: 10px; border: 2px solid var(--ouro); 
            max-width: 90%; text-align: center; box-shadow: 0 0 20px var(--ouro); 
        }
        .modal h2 { margin-top: 0; color: var(--ouro); }
        
        /* Chat */
        .chat-area { margin-top: 20px; border-top: 1px solid #444; padding-top: 10px; }
        #chat-msgs { height: 100px; overflow-y: auto; text-align: left; font-size: 12px; margin-bottom: 5px; color: #aaa; }
        .msg-sistema { color: var(--ouro); font-style: italic; }

    </style>
</head>
<body>

    <div class="topo-fixo">
        <div class="topo-info">PING√ÉO V11</div>
        <div id="status-fichas" class="topo-info">üí∞ 500</div>
        <button class="btn-ranking" onclick="toggleRanking()">üèÜ Ranking</button>
    </div>

    <div class="container">

        <div id="tela-login" class="tela ativa">
            <h1>FERVE A CUCA üî•</h1>
            <p>Digite seu nome para entrar:</p>
            <input type="text" id="nome-jogador" placeholder="Seu apelido..." maxlength="12">
            <br>
            <button class="btn-grande" onclick="entrar()">ENTRAR</button>
        </div>

        <div id="tela-lobby" class="tela">
            <h2>Aguardando...</h2>
            <p id="msg-lobby">O Host iniciar√° a partida em breve.</p>
            <div id="area-host" style="display:none; margin-top:20px;">
                <p style="color:var(--ouro)">üëë Voc√™ √© o Host</p>
                <button class="btn-grande" onclick="iniciarPartida()">INICIAR JOGO</button>
            </div>
            <div class="chat-area">
                <div id="chat-msgs"></div>
                <input type="text" id="input-chat" placeholder="Mensagem..." style="width:70%; font-size:14px;">
                <button onclick="enviarChatTexto()" style="width:20%; font-size:14px;">Env</button>
            </div>
        </div>

        <div id="tela-jogo" class="tela">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:12px; color:#aaa;">RODADA <span id="num-rodada">1</span></span>
                <span style="font-size:12px; color:#aaa;">‚è≥ <span id="timer">00</span>s</span>
            </div>
            
            <div class="alvo-box">ALVO: <span id="alvo-num">?</span></div>
            
            <div class="visor-conta" id="visor-conta">_</div>
            
            <div class="area-cartas" id="area-cartas">
                </div>

            <div class="controles">
                <button class="btn-op" onclick="add('+')">+</button>
                <button class="btn-op" onclick="add('-')">-</button>
                <button class="btn-op" onclick="add('*')">x</button>
                <button class="btn-op" onclick="add('/')">√∑</button>
                <button class="btn-op" onclick="add('(')">(</button>
                <button class="btn-op" onclick="add(')')">)</button>
            </div>

            <div class="acoes-jogo">
                <button class="btn-grande btn-limpar" onclick="limpar()">LIMPAR</button>
                <button class="btn-grande btn-enviar" onclick="enviarJogada()">ENVIAR</button>
            </div>

            <button class="btn-desistir" onclick="desistir()">üè≥Ô∏è DESISTIR DA RODADA (Salvar Fichas)</button>

        </div>
        
        <div id="tela-discordia" class="tela">
            <h2 style="color:var(--vermelho)">SALA DA DISC√ìRDIA üòà</h2>
            <p>Doe fichas para salvar algu√©m (e pule a pr√≥xima vez) ou guarde para si.</p>
            <div id="lista-doacao" style="text-align:left; margin:20px 0;"></div>
            <div id="host-discordia" style="display:none;">
                <button class="btn-grande" onclick="encerrarDiscordia()">ENCERRAR NEGOCIA√á√ÉO</button>
            </div>
        </div>

    </div>

    <div id="modal-ranking" class="modal" onclick="if(event.target===this) toggleRanking()">
        <div class="modal-content">
            <h2>üèÜ RANKING</h2>
            <ul id="lista-ranking"></ul>
            <button class="btn-grande" onclick="toggleRanking()" style="margin-top:10px; background:#555; color:#fff;">FECHAR</button>
        </div>
    </div>

    <div id="modal-resultado" class="modal">
        <div class="modal-content">
            <h2 id="res-titulo">RESULTADO</h2>
            <p id="res-msg" style="font-size:18px;"></p>
            <div id="res-extra" style="color:var(--vermelho); font-weight:bold; margin-top:10px;"></div>
            <br>
            <p style="font-size:12px; color:#aaa;">Pr√≥xima rodada em breve...</p>
        </div>
    </div>

    <script>
        let socket;
        let meuNome = "";
        let conta = "";
        let cartasMinhaMao = [];
        let qtdCartasUsadas = 0;
        let rodadaAtual = 0;

        // Conex√£o
        function conectar() {
            const protocolo = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Pega o nome da sala da URL ou usa padr√£o
            const params = new URLSearchParams(window.location.search);
            const sala = params.get('sala') || 'sala-padrao';
            
            socket = new WebSocket(`${protocolo}//${window.location.host}/ws?sala=${sala}`);

            socket.onopen = () => {
                console.log("Conectado!");
                // Se tiver nome salvo (reconex√£o), tenta entrar direto
                if(meuNome) socket.send(JSON.stringify({ type: 'JOIN', nome: meuNome }));
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                processarMensagem(data);
            };
            
            socket.onclose = () => {
                console.log("Desconectado. Tentando reconectar...");
                setTimeout(conectar, 2000);
            };
        }

        function entrar() {
            const nomeInput = document.getElementById('nome-jogador').value.trim();
            if (!nomeInput) return alert("Digite um nome!");
            meuNome = nomeInput;
            conectar();
        }

        function processarMensagem(data) {
            if (data.type === 'INFO_PLAYER') {
                mudarTela('tela-lobby');
                document.getElementById('area-host').style.display = data.isHost ? 'block' : 'none';
                if(data.isHost) document.getElementById('msg-lobby').innerText = "Voc√™ √© o Host. Inicie quando todos estiverem prontos.";
            }
            
            if (data.type === 'LISTA') {
                atualizarRanking(data.lista);
                // Atualiza se sou host em tempo real (caso o host tenha sa√≠do)
                const eu = data.lista.find(j => j.nome === meuNome);
                if (eu) {
                    document.getElementById('status-fichas').innerText = `üí∞ ${eu.fichas}`;
                    document.getElementById('area-host').style.display = eu.isHost ? 'block' : 'none';
                    if (document.getElementById('tela-discordia').classList.contains('ativa')) {
                         document.getElementById('host-discordia').style.display = eu.isHost ? 'block' : 'none';
                    }
                }
            }

            if (data.type === 'SUA_MAO') {
                esconderModais();
                mudarTela('tela-jogo');
                rodadaAtual = data.rodada;
                document.getElementById('num-rodada').innerText = data.rodada;
                document.getElementById('alvo-num').innerText = data.alvo;
                renderizarCartas(data.cartas);
                limpar();
            }
            
            if (data.type === 'ESPERANDO_RODADA') {
                 mudarTela('tela-lobby');
                 document.getElementById('msg-lobby').innerText = `Rodada ${data.rodada} em andamento. Aguarde a pr√≥xima...`;
            }
            
            if (data.type === 'CONTAGEM') {
                document.getElementById('timer').innerText = data.tempo;
                if(data.tempo <= 5) document.getElementById('timer').style.color = 'red';
                else document.getElementById('timer').style.color = 'white';
            }

            if (data.type === 'FIM_RODADA') {
                mostrarResultado(data);
            }

            if (data.type === 'PULOU_VEZ') {
                mudarTela('tela-lobby');
                document.getElementById('msg-lobby').innerText = "Voc√™ pulou esta vez (puni√ß√£o por doa√ß√£o). Aguarde...";
            }

            if (data.type === 'INICIO_NEGOCIACAO') {
                mudarTela('tela-discordia');
                const eu = document.getElementById('area-host').style.display === 'block'; // Checagem simples visual
                document.getElementById('host-discordia').style.display = eu ? 'block' : 'none';
            }
            
            if (data.type === 'CHAT_UPDATE') {
                const div = document.getElementById('chat-msgs');
                div.innerHTML = data.log.map(l => {
                    if(l.sistema) return `<div class="msg-sistema">${l.msg}</div>`;
                    return `<div><b>${l.nome}:</b> ${l.msg}</div>`;
                }).join('');
                div.scrollTop = div.scrollHeight;
            }

            if (data.type === 'GAME_OVER') {
                alert(`FIM DE JOGO! Vencedor: ${data.vencedor}`);
                location.reload();
            }
        }

        // L√≥gica de Jogo
        function renderizarCartas(cartas) {
            const area = document.getElementById('area-cartas');
            area.innerHTML = "";
            cartas.forEach((valor, i) => {
                const el = document.createElement('div');
                el.className = `carta ${[1,2,3].includes(Math.floor(Math.random()*4)) ? '' : 'carta-red'}`; // Cor aleat√≥ria s√≥ visual
                el.innerText = valor;
                el.onclick = () => usarCarta(valor, el);
                area.appendChild(el);
            });
            qtdCartasUsadas = 0;
        }

        function usarCarta(valor, elemento) {
            if (elemento.classList.contains('usada')) return;
            conta += valor;
            elemento.classList.add('usada');
            qtdCartasUsadas++;
            atualizarVisor();
        }

        function add(op) {
            conta += op;
            atualizarVisor();
        }

        function atualizarVisor() {
            document.getElementById('visor-conta').innerText = conta;
        }

        function limpar() {
            conta = "";
            qtdCartasUsadas = 0;
            document.querySelectorAll('.carta').forEach(c => c.classList.remove('usada'));
            atualizarVisor();
        }

        function enviarJogada() {
            if (qtdCartasUsadas < 4) return alert("Use todas as 4 cartas!");
            try {
                // Seguran√ßa b√°sica contra eval malicioso
                if (/[^0-9+\-*/().]/.test(conta)) throw new Error("Inv√°lido");
                const resultado = eval(conta);
                const alvo = parseInt(document.getElementById('alvo-num').innerText);
                const dist = Math.abs(alvo - resultado);
                
                socket.send(JSON.stringify({ 
                    type: 'JOGADA', 
                    valor: resultado, 
                    distancia: dist,
                    tempo: document.getElementById('timer').innerText 
                }));
                
                mudarTela('tela-lobby');
                document.getElementById('msg-lobby').innerText = "Resposta enviada! Aguardando outros...";
                
            } catch (e) { alert("Conta inv√°lida!"); }
        }

        function desistir() {
            if(confirm("Desistir rodada? Voc√™ ficar√° com 9999 de dist√¢ncia, mas n√£o perder√° fichas extras.")) {
                socket.send(JSON.stringify({type:'DESISTIR'}));
                mudarTela('tela-lobby');
                document.getElementById('msg-lobby').innerText = "Voc√™ desistiu desta rodada.";
            }
        }

        function iniciarPartida() {
            socket.send(JSON.stringify({ type: 'START_GAME' }));
        }

        function encerrarDiscordia() {
            socket.send(JSON.stringify({ type: 'ENCERRAR_DISCORDIA' }));
        }
        
        // Chat e Doa√ß√£o
        function enviarChatTexto() {
            const input = document.getElementById('input-chat');
            const msg = input.value;
            if(msg) {
                socket.send(JSON.stringify({type:'CHAT_MSG', nome:meuNome, msg:msg}));
                input.value="";
            }
        }

        function doarFichas(nomeDestino) {
            const valor = prompt(`Quanto quer doar para ${nomeDestino}? (Voc√™ pular√° a pr√≥xima rodada!)`);
            if (valor && parseInt(valor) > 0) {
                socket.send(JSON.stringify({type:'DOAR_FICHAS', para:nomeDestino, valor:valor}));
            }
        }

        // UI Auxiliar
        function toggleRanking() {
            const modal = document.getElementById('modal-ranking');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function atualizarRanking(lista) {
            const ul = document.getElementById('lista-ranking');
            const listaDoacao = document.getElementById('lista-doacao');
            
            ul.innerHTML = "";
            listaDoacao.innerHTML = "";
            
            // Ordena por fichas
            lista.sort((a,b) => b.fichas - a.fichas);
            
            lista.forEach((j, i) => {
                // Lista Principal
                const li = document.createElement('li');
                li.className = `item-ranking ${j.eliminado ? 'eliminado' : ''} ${i===0 ? 'lider' : ''}`;
                li.innerHTML = `
                    <span>${i+1}. ${j.nome} ${j.isHost ? 'üëë' : ''}</span>
                    <span>${j.fichas}</span>
                `;
                ul.appendChild(li);
                
                // Lista de Doa√ß√£o (Disc√≥rdia) - S√≥ mostra outros vivos
                if (j.nome !== meuNome && !j.eliminado) {
                    const div = document.createElement('div');
                    div.style.marginBottom = "10px";
                    div.innerHTML = `
                        <button onclick="doarFichas('${j.nome}')" style="background:#444; color:#fff; border:1px solid #777; padding:5px; width:100%;">
                            Doar para ${j.nome} (${j.fichas})
                        </button>
                    `;
                    listaDoacao.appendChild(div);
                }
            });
        }

        function mostrarResultado(data) {
            const modal = document.getElementById('modal-resultado');
            const titulo = document.getElementById('res-titulo');
            const msg = document.getElementById('res-msg');
            const extra = document.getElementById('res-extra');

            titulo.innerText = `VENCEDOR: ${data.vencedor}`;
            msg.innerHTML = `
                Resultado: <b>${data.valor}</b> (Dist: ${data.dist})<br>
                Pr√™mio: <span style="color:var(--verde-neon)">+${data.premio}</span>
            `;
            extra.innerText = data.msgExtra || "";

            modal.style.display = 'flex';
            
            // Fecha sozinho ap√≥s 7s
            setTimeout(() => { modal.style.display = 'none'; }, 7000);
        }

        function mudarTela(id) {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa'));
            document.getElementById(id).classList.add('ativa');
        }

        function esconderModais() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }

    </script>
</body>
</html>
