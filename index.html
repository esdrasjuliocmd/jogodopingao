<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Desafio do Ping√£o</title>
    <style>
        body { font-family: 'Comic Sans MS', sans-serif; background: #fdfdfd; text-align: center; margin: 0; padding-bottom: 50px; }
        .topo { background: #FF6B6B; color: white; padding: 20px; border-radius: 0 0 30px 30px; }
        .tela { display: none; padding: 20px; }
        .ativa { display: block; }
        .caixa { background: white; border: 3px solid #4ECDC4; border-radius: 20px; padding: 20px; margin: 10px auto; max-width: 400px; box-shadow: 6px 6px 0 #4ECDC4; }
        input { width: 85%; padding: 12px; margin: 10px; border-radius: 10px; border: 2px solid #ddd; font-size: 16px; }
        .btn-principal { background: #4ECDC4; color: white; padding: 15px 40px; border: none; border-radius: 50px; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 0 #36918a; }
        .carta { width: 60px; height: 90px; background: white; border: 3px solid #4ECDC4; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; font-size: 25px; font-weight: bold; margin: 5px; cursor: pointer; box-shadow: 3px 3px 0 #4ECDC4; }
        .sinal { padding: 10px 15px; font-size: 20px; margin: 5px; border: none; border-radius: 10px; background: #FF6B6B; color: white; font-weight: bold; cursor: pointer; }
        #lista-jogadores { text-align: left; background: #f9f9f9; padding: 10px; border-radius: 10px; }
        .alvo { background: #FFE66D; padding: 15px; border-radius: 15px; font-weight: bold; border: 2px dashed #FF6B6B; margin: 10px; }
    </style>
</head>
<body>

    <div id="tela-entrada" class="tela ativa">
        <div class="topo"><h1>üòé Desafio do Ping√£o</h1></div>
        <div class="caixa">
            <h3 id="msg-convite">Crie sua Sala</h3>
            <input type="text" id="nome-player" placeholder="Seu Nome">
            <div id="area-sala">
                <input type="text" id="nome-sala" placeholder="Nome da Sala">
            </div>
            <button class="btn-principal" onclick="conectar()">ENTRAR NO JOGO</button>
            <p id="link-share" style="font-size: 12px; color: #888; margin-top: 15px;"></p>
        </div>
    </div>

    <div id="tela-lobby" class="tela">
        <div class="topo"><h1>üè† Sala: <span id="sala-id"></span></h1></div>
        <div class="caixa">
            <h4>Quem j√° chegou:</h4>
            <div id="lista-jogadores"></div>
            <br>
            <button class="btn-principal" style="background:#FF6B6B; box-shadow: 0 5px 0 #b34a4a;" onclick="comecarJogo()">INICIAR RODADA!</button>
        </div>
    </div>

    <div id="tela-jogo" class="tela">
        <div class="topo"><h1 id="status-rodada">Bora!</h1><div id="relogio" style="font-size: 30px;">90</div></div>
        <div class="alvo">üéØ ALVO: 11</div>
        <div id="visor-conta" style="font-size: 30px; padding: 20px; background: #eee; margin: 10px; border-radius: 10px;">_ ? _</div>
        <div id="cartas-area">
            <div class="carta" onclick="colocar('5')">5</div>
            <div class="carta" onclick="colocar('2')">2</div>
            <div class="carta" onclick="colocar('9')">9</div>
        </div>
        <div style="margin: 15px;">
            <button class="sinal" onclick="colocar('+')">+</button>
            <button class="sinal" onclick="colocar('-')">-</button>
            <button class="sinal" onclick="colocar('*')">√ó</button>
            <button class="sinal" onclick="colocar('/')">√∑</button>
            <button class="sinal" style="background:#333" onclick="limpar()">Limpar</button>
        </div>
        <button id="btn-enviar" class="btn-principal" onclick="enviar()">ENVIAR JOGADA!</button>
        <button id="btn-proxima" class="btn-principal" style="display:none; background:#FFE66D; color:#333;" onclick="comecarJogo()">PR√ìXIMA RODADA!</button>
    </div>

    <script>
        let socket;
        let minhaConta = "";
        let meuNome = "";

        // L√≥gica do Link Autom√°tico
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sala = urlParams.get('sala');
            if(sala) {
                document.getElementById('nome-sala').value = sala;
                document.getElementById('area-sala').style.display = 'none';
                document.getElementById('msg-convite').innerText = "Entrando na sala: " + sala;
            }
        };

        function conectar() {
            meuNome = document.getElementById('nome-player').value;
            const sala = document.getElementById('nome-sala').value;
            if(!meuNome || !sala) return alert("Preencha tudo!");

            socket = new WebSocket('wss://pingao-backend.esdrasjulio.workers.dev/');

            socket.onopen = () => {
                socket.send(JSON.stringify({type:'JOIN', nome:meuNome, sala:sala}));
                document.getElementById('sala-id').innerText = sala;
                mostrarTela('tela-lobby');
                // Gera o link para compartilhar
                const link = window.location.origin + window.location.pathname + "?sala=" + sala;
                document.getElementById('link-share').innerText = "Link da sala: " + link;
            };

            socket.onmessage = (e) => {
                const d = JSON.parse(e.data);
                if(d.type === 'LISTA_JOGADORES') {
                    const html = d.lista.map(j => `<div>${j.pronto ? '‚úÖ' : '‚è≥'} ${j.nome}</div>`).join('');
                    document.getElementById('lista-jogadores').innerHTML = html;
                }
                if(d.type === 'START') {
                    mostrarTela('tela-jogo');
                    document.getElementById('btn-enviar').style.display = 'inline-block';
                    document.getElementById('btn-proxima').style.display = 'none';
                    document.getElementById('status-rodada').innerText = "Bora!";
                    limpar();
                }
                if(d.type === 'FIM_RODADA') {
                    document.getElementById('status-rodada').innerText = `üèÜ VENCEDOR: ${d.vencedor} (${d.valor})`;
                    document.getElementById('btn-enviar').style.display = 'none';
                    document.getElementById('btn-proxima').style.display = 'inline-block';
                }
            };
        }

        function comecarJogo() { socket.send(JSON.stringify({type:'START'})); }
        function mostrarTela(id) { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById(id).classList.add('ativa'); }
        function colocar(v) { minhaConta += v; document.getElementById('visor-conta').innerText = minhaConta; }
        function limpar() { minhaConta = ""; document.getElementById('visor-conta').innerText = "_ ? _"; }

        function enviar() {
            try {
                let res = eval(minhaConta);
                let dist = Math.abs(11 - res);
                socket.send(JSON.stringify({type:'ENVIAR_RESULTADO', nome:meuNome, valor: res, distancia: dist}));
                document.getElementById('btn-enviar').style.display = 'none';
                document.getElementById('status-rodada').innerText = "Aguardando os outros...";
            } catch(e) { alert("Conta errada!"); }
        }
    </script>
</body>
</html>
