<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ferve a Cuca: Final</title>
    <style>
        :root {
            --ouro: #FFD700;
            --ouro-dark: #FFA000;
            --vermelho: #D32F2F;
            --vermelho-dark: #B71C1C;
            --verde: #2E7D32;
            --verde-neon: #00E676;
            --bg-mesa: #0f3818;
            --preto-transparente: rgba(0, 0, 0, 0.4);
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-mesa); 
            text-align: center; 
            margin: 0; 
            padding-bottom: 20px; 
            color: #fff; 
            overflow-x: hidden; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Topo Fixo e Ranking */
        .topo-fixo { 
            background: #111; 
            border-bottom: 2px solid var(--ouro); 
            padding: 5px; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
        }
        .topo-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 2px 10px; 
        }
        .ranking-bar { 
            display: flex; 
            gap: 10px; 
            overflow-x: auto; 
            padding: 5px; 
            background: #222; 
            white-space: nowrap; 
            scrollbar-width: none; 
        }
        .ranking-bar::-webkit-scrollbar { display: none; }
        
        .rank-item { 
            font-size: 11px; 
            padding: 3px 8px; 
            background: #333; 
            border-radius: 10px; 
            border: 1px solid #444; 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        .rank-item.lider { border-color: var(--ouro); color: var(--ouro); background: rgba(255, 215, 0, 0.1); }

        .tela { display: none; padding: 10px; position: relative; z-index: 5; margin-top: 5px; }
        .ativa { display: block; }
        
        /* AJUSTE PARA CABER NA TELA */
        .caixa { 
            background: rgba(255, 255, 255, 0.95); 
            color: #333; 
            border-radius: 15px; 
            padding: 20px; 
            margin: 10px auto; 
            max-width: 450px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            border: 2px solid var(--ouro); 
        }
        input { width: 90%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; text-align: center; }
        
        .btn-principal { 
            background: linear-gradient(180deg, #D32F2F, #B71C1C); 
            color: white; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 5px; 
            box-shadow: 0 4px 0 #7F0000; 
        }

        /* √ÅREA DE JOGO COMPACTA */
        #alvo-display { 
            background: linear-gradient(45deg, #FFD700, #FFC107); 
            color: #000; 
            padding: 10px; 
            font-weight: bold; 
            font-size: 22px; 
            border-radius: 8px; 
            margin-bottom: 5px; 
            border: 2px solid #FFA000; 
        }
        
        #visor-conta { 
            font-size: 28px; 
            background: #fff; 
            color: #333; 
            padding: 10px; 
            margin: 5px 0; 
            font-weight: bold; 
            border-radius: 8px; 
            min-height: 40px; 
            border: 3px solid #ccc; 
        }

        #area-cartas { 
            display: flex; 
            justify-content: center; 
            gap: 5px; 
            margin: 10px 0; 
            flex-wrap: nowrap; /* Mant√©m na mesma linha */
        }
        .carta-real { 
            width: 18%; 
            max-width: 70px; 
            height: auto; 
            cursor: pointer; 
            transition: transform 0.1s; 
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5)); 
        }
        
        .sinal { 
            width: 50px; 
            height: 50px; 
            font-size: 22px; 
            margin: 2px; 
            border: none; 
            border-radius: 10px; 
            background: #263238; 
            color: white; 
            cursor: pointer; 
            border-bottom: 4px solid #000; 
        }
        
        #barra-tempo-container { width: 100%; height: 5px; background: #333; position: absolute; bottom: 0; left: 0; }
        #barra-tempo { width: 100%; height: 100%; background: #00E676; transition: width 1s linear; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; padding: 20px; }
        
        .tag-player { font-size: 11px; background: #222; padding: 4px 8px; border-radius: 12px; border: 1px solid #555; }
        .tag-player.pronto { background: #2E7D32; border-color: #00E676; }
    </style>
</head>
<body>

    <div class="topo-fixo">
        <div class="topo-info">
            <span style="font-size:12px; color:#aaa;">üí∞ Fichas: <span id="minhas-fichas-topo" style="color:#FFD700; font-weight:bold;">500</span></span>
            <span id="sala-nome-topo" style="font-size:12px; color:#aaa;"></span>
        </div>
        <div id="barra-ranking" class="ranking-bar"></div>
        <div id="barra-tempo-container"><div id="barra-tempo"></div></div>
    </div>

    <div id="tela-entrada" class="tela ativa">
        <h1 style="font-size: 35px; color: gold; margin-bottom: 0;">PING√ÉO</h1>
        <div class="caixa">
            <input type="text" id="nome-player" placeholder="Seu Nome">
            <div id="div-sala"><input type="text" id="nome-sala" placeholder="Nome da Sala"></div>
            <button class="btn-principal" onclick="entrar()">SENTAR NA MESA</button>
        </div>
    </div>

    <div id="tela-lobby" class="tela">
        <div class="caixa">
            <div id="link-texto" style="font-size:10px; color:#555; margin-bottom: 10px;"></div>
            <div id="lista-lobby"></div>
            <button id="btn-iniciar" class="btn-principal" style="display:none; background: #2E7D32;" onclick="iniciarComSom()">DISTRIBUIR CARTAS</button>
        </div>
    </div>

    <div id="tela-jogo" class="tela">
        <div id="info-rodada" style="font-size: 12px; margin-bottom: 5px;">Rodada 1</div>
        <div id="painel-jogadores" style="display:flex; justify-content:center; gap:5px; margin-bottom:10px;"></div>
        
        <div id="alvo-display">ALVO: ?</div>
        <div id="visor-conta">_</div>
        <div id="area-cartas"></div>
        
        <div style="margin-top: 10px;">
            <button class="sinal" onclick="tocarSom('click'); add('+')">+</button>
            <button class="sinal" onclick="tocarSom('click'); add('-')">-</button>
            <button class="sinal" onclick="tocarSom('click'); add('*')">√ó</button>
            <button class="sinal" onclick="tocarSom('click'); add('/')">√∑</button>
            <button class="sinal" style="background:#D32F2F;" onclick="tocarSom('click'); limpar()">C</button>
            <br>
            <button class="sinal" style="background:#424242;" onclick="tocarSom('click'); add('(')">(</button>
            <button class="sinal" style="background:#424242;" onclick="tocarSom('click'); add(')')">)</button>
        </div>
        
        <button id="btn-enviar" class="btn-principal" onclick="enviar()">CONFIRMAR JOGADA</button>
        <button class="btn-principal" style="background: #37474F; font-size: 12px; margin-top: 10px;" onclick="desistir()">üè≥Ô∏è DESISTIR</button>
    </div>

    <div id="modal-rodada" class="modal">
        <h2 id="txt-vencedor" style="color: #00E676;">...</h2>
        <h3 id="txt-premio" style="color: #FFD700; font-size: 40px;"></h3>
        <p id="txt-detalhe" style="font-size: 16px;">...</p>
        <div id="contador-regressivo" style="font-size: 50px; font-weight: bold; color: gold;">8</div>
    </div>

    <script>
        let socket, conta = "", meuNome = "", minhaSala = "", alvoAtual = 0, tempoRestante = 60, timerInterval, qtdCartasUsadas = 0, souHost = false;

        const audioLibrary = {
            click: new Audio('https://codeskulptor-demos.commondatastorage.googleapis.com/pang/pop.mp3'),
            entrou: new Audio('https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/pause.wav'), 
            vitoria: new Audio('https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/bonus.wav')
        };

        function tocarSom(tipo) { try { const som = audioLibrary[tipo]; if(som) { som.currentTime = 0; som.play().catch(e=>{}); } } catch(e){} }
        function iniciarComSom() { tocarSom('click'); socket.send(JSON.stringify({type:'START'})); }

        function entrar() {
            meuNome = document.getElementById('nome-player').value.trim();
            minhaSala = document.getElementById('nome-sala').value.trim();
            if(!meuNome || !minhaSala) return alert("Preencha tudo!");
            
            document.getElementById('sala-nome-topo').innerText = `| Sala: ${minhaSala}`;
            document.getElementById('link-texto').innerText = window.location.href.split('?')[0] + "?sala=" + encodeURIComponent(minhaSala);
            mudarTela('tela-lobby');

            socket = new WebSocket(`wss://pingao-backend.esdrasjulio.workers.dev/?sala=${minhaSala}`);
            socket.onopen = () => socket.send(JSON.stringify({type: 'JOIN', nome: meuNome}));
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'INFO_PLAYER') {
                    souHost = data.isHost;
                    if(souHost) document.getElementById('btn-iniciar').style.display = 'block';
                }

                if (data.type === 'LISTA') {
                    atualizarListas(data.lista);
                    const eu = data.lista.find(p => p.nome === meuNome);
                    if(eu) document.getElementById('minhas-fichas-topo').innerText = eu.fichas;
                }

                if (data.type === 'SUA_MAO') {
                    esconderModais();
                    mudarTela('tela-jogo');
                    limpar();
                    alvoAtual = data.alvo;
                    iniciarTimer(60);
                    document.getElementById('alvo-display').innerText = "ALVO: " + alvoAtual;
                    const area = document.getElementById('area-cartas');
                    area.innerHTML = "";
                    data.cartas.forEach(num => {
                        let vImg = num;
                        if(num===1) vImg="A"; if(num===10) vImg="0"; if(num===11) vImg="J"; if(num===12) vImg="Q"; if(num===13) vImg="K";
                        const imgUrl = `https://deckofcardsapi.com/static/img/${vImg}S.png`;
                        // CONSERTO CIR√öRGICO: Chama o som e o add diretamente para evitar erros de escopo
                        area.innerHTML += `<img src="${imgUrl}" class="carta-real" onclick="tocarSom('click'); add('${num}'); qtdCartasUsadas++; this.style.opacity='0.5'; this.onclick=null;">`;
                    });
                    document.getElementById('btn-enviar').style.display = 'block';
                }

                if (data.type === 'FIM_RODADA') {
                    document.getElementById('modal-rodada').style.display = 'flex';
                    document.getElementById('txt-vencedor').innerText = `${data.vencedor} Venceu!`;
                    document.getElementById('txt-premio').innerText = `${data.premio>=0?'+':''}${data.premio} üí∞`;
                    document.getElementById('txt-detalhe').innerText = `Resultado: ${data.valor}`;
                }

                if (data.type === 'CONTAGEM') {
                    document.getElementById('contador-regressivo').innerText = data.tempo;
                }
            };
        }

        function atualizarListas(lista) {
            const lobby = document.getElementById('lista-lobby');
            const painel = document.getElementById('painel-jogadores');
            const bar = document.getElementById('barra-ranking');
            lobby.innerHTML = ""; painel.innerHTML = ""; bar.innerHTML = "";
            lista.sort((a,b)=>b.fichas-a.fichas).forEach((p, i) => {
                lobby.innerHTML += `<div>${p.nome} - üí∞${p.fichas}</div>`;
                painel.innerHTML += `<div class="tag-player ${p.pronto?'pronto':''}">${p.nome}</div>`;
                bar.innerHTML += `<div class="rank-item ${i===0?'lider':''}">#${i+1} ${p.nome}: ${p.fichas}</div>`;
            });
        }

        function iniciarTimer(s) {
            tempoRestante = s; const b = document.getElementById('barra-tempo');
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                tempoRestante--; b.style.width = ((tempoRestante/60)*100) + '%';
                if(tempoRestante<=0) clearInterval(timerInterval);
            }, 1000);
        }

        function add(v) { 
            conta += v; 
            document.getElementById('visor-conta').innerText = conta; 
        }

        function limpar() { 
            conta = ""; 
            qtdCartasUsadas = 0; 
            document.getElementById('visor-conta').innerText = "_"; 
        }

        function enviar() {
            if (qtdCartasUsadas < 3) return alert("Use pelo menos 3 cartas!");
            try {
                const res = eval(conta.replace(/[^0-9\+\-\*\/\(\)\.]/g, ''));
                socket.send(JSON.stringify({ type: 'JOGADA', nome: meuNome, valor: res, distancia: Math.abs(alvoAtual - res), tempo: 60 - tempoRestante }));
                document.getElementById('btn-enviar').style.display = 'none';
            } catch(e) { alert("Conta inv√°lida!"); }
        }

        function mudarTela(id) { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById(id).classList.add('ativa'); }
        function esconderModais() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function desistir() { if(confirm("Desistir rodada?")) socket.send(JSON.stringify({type:'DESISTIR', nome:meuNome})); }
    </script>
</body>
</html>
